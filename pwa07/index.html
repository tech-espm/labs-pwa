<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />

	<!-- Conte√∫do gerado pelo Favicon Helper -->
	<meta property="og:locale" content="pt_BR" />
	<meta property="og:type" content="website" />
	<meta property="og:url" content="https://tech-espm.github.io/labs-pwa" />
	<meta property="og:title" content="Workshop PWA" />
	<meta property="og:site_name" content="Workshop PWA" />
	<meta property="og:description" content="Material e exemplos do workshop sobre PWA" />
	<meta property="og:image" content="https://tech-espm.github.io/labs-pwa/assets/images/pwa.png" />
	<meta property="og:image:type" content="image/png" />
	<meta property="og:image:width" content="1024" />
	<meta property="og:image:height" content="1024" />
	<meta name="author" content="Carlos Rafael Gimenes das Neves" />
	<meta name="description" content="Material e exemplos do workshop sobre PWA" />
	<meta name="keywords" content="material, exemplos, workshop, pwa" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="apple-mobile-web-app-title" content="Workshop PWA" />
	<link rel="apple-touch-icon" sizes="57x57" href="../assets/favicons/apple-icon-57x57.png" />
	<link rel="apple-touch-icon" sizes="60x60" href="../assets/favicons/apple-icon-60x60.png" />
	<link rel="apple-touch-icon" sizes="72x72" href="../assets/favicons/apple-icon-72x72.png" />
	<link rel="apple-touch-icon" sizes="76x76" href="../assets/favicons/apple-icon-76x76.png" />
	<link rel="apple-touch-icon" sizes="114x114" href="../assets/favicons/apple-icon-114x114.png" />
	<link rel="apple-touch-icon" sizes="120x120" href="../assets/favicons/apple-icon-120x120.png" />
	<link rel="apple-touch-icon" sizes="144x144" href="../assets/favicons/apple-icon-144x144.png" />
	<link rel="apple-touch-icon" sizes="152x152" href="../assets/favicons/apple-icon-152x152.png" />
	<link rel="apple-touch-icon" sizes="180x180" href="../assets/favicons/apple-icon-180x180.png" />
	<link rel="icon" type="image/png" sizes="512x512" href="../assets/favicons/favicon-512x512.png" />
	<link rel="icon" type="image/png" sizes="192x192" href="../assets/favicons/favicon-192x192.png" />
	<link rel="icon" type="image/png" sizes="96x96" href="../assets/favicons/favicon-96x96.png" />
	<link rel="icon" type="image/png" sizes="48x48" href="../assets/favicons/favicon-48x48.png" />
	<link rel="icon" type="image/png" sizes="32x32" href="../assets/favicons/favicon-32x32.png" />
	<link rel="icon" type="image/png" sizes="16x16" href="../assets/favicons/favicon-16x16.png" />
	<link rel="Shortcut Icon" href="../assets/favicons/favicon.png" />
	<link rel="manifest" href="manifest.json" />
	<meta name="msapplication-config" content="browserconfig.xml" />
	<meta name="theme-color" content="#5a0fc8" />
	<!-- Fim do conte√∫do gerado pelo Favicon Helper -->

	<title>
		PWA de Exemplo 07
	</title>

	<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans:400,600|Source+Code+Pro&display=swap" />
	<link rel="stylesheet" type="text/css" href="../assets/css/style.css" />

</head>
<body>
	<main>

		<h1>
			PWA de Exemplo 07
		</h1>

		<p>
			Neste exemplo iremos explorar o funcionamento dos eventos <span class="codigo">install</span> e <span class="codigo">activate</span> dos Service Workers.
		</p>

		<p>
			O evento <span class="codigo">install</span> acontece em algum momento depois da execu√ß√£o do m√©todo <span class="codigo">navigator.serviceWorker.register()</span>.
			Neste momento, o Service Worker tem oportunidade de preparar todos os arquivos e configura√ß√µes necess√°rias para que ele funcione corretamente.
			Isso pode incluir a cria√ß√£o de um <a href="https://developer.mozilla.org/en-US/docs/Web/API/CacheStorage" target="_blank">cache</a> para armazenar os arquivos necess√°rios para fazer o aplicativo funcionar offline.
		</p>

		<p>
			Como j√° visto em exemplos anteriores, uma vez instalado, o Service Worker n√£o come√ßa a valer instantaneamente.
			O mesmo ocorre quando ele √© alterado, mas de forma ligeiramente diferente...
		</p>

		<img alt="Imagem de exemplo" src="abc.jpg" />

		<img alt="Outra imagem de exemplo" src="def.jpg" />

		<p>
			Por exemplo, as imagens acima apontam para arquivos que propositalmente n√£o existem.
			Logo, na primeira vez que a p√°gina √© aberta veremos dois erros, apesar do Service Worker tratar arquivos com extens√£o jpg.
			Isso ocorre porque, como vimos anteriormente, o Service Worker ainda n√£o estava instalado/ativo na primeira vez que a p√°gina foi aberta.
			Mas o significado real dessa frase s√≥ pode ser compreendido com outro exemplo, j√° que algu√©m pode (erroneamente) pensar <i>"Claro! Na primeira vez, o Service Worker n√£o tratou as imagens acima porque ele s√≥ foi registrado no final da p√°gina! Eu olhei nas ferramentas de desenvolvedor e vi que o Service Worker estava OK! Se aparecesse outra imagem <b>depois</b> do Service Worker ter sido registrado, ele teria tratado!"</i>.
		</p>

		<p>
			Assim, por que n√£o criar um bot√£o para adicionar imagens dinamicamente üòÅ?
			<button type="button" onclick="adicionarImagem()">Adicionar Imagem</button>
		</p>
		
		<div id="divPai">
			As novas imagens aparecer√£o aqui:
		</div>
		
		<p>
			O que ocorre quando voc√™ adiciona novas imagens???
			Exatamente!
			Nada de diferente!
			Voc√™ continua recebendo erros!!!
			Isso significa que o Service Worker, apesar de aparecer como OK (como na imagem abaixo), n√£o est√° sendo utilizado para a p√°gina atual, por uma quest√£o de coer√™ncia.
		</p>

		<img alt="Service Worker OK" src="../assets/images/swok.png" />

		<p>
			Se a p√°gina come√ßou <b>sem</b> o Service Worker, o navegador deixa que ela continue vivendo <b>sem</b> o Service Worker.
			Assim que voc√™ recarregar a p√°gina, ou fechar a aba e abrir de novo, a hist√≥ria muda, e, como o Service Worker j√° est√° instalado e ativo, ele ser√° utilizado na p√°gina!
		</p>

		<p>
			<b>Recomento fortemente que voc√™ atualize a p√°gina agora, para ver as barras pretas e brancas, e fazer a pr√≥xima parte do exemplo ter sentido üòÅüòÅüòÅ!</b>
		</p>

		<p>
			Esse comportamento pode ser alterado utilizando o m√©todo <span class="codigo">clients.claim()</span>, mostrado <a href="https://developer.mozilla.org/en-US/docs/Web/API/Clients/claim" target="_blank">aqui</a>, e est√° relacionado com o evento <span class="codigo">activate</span>.
			O passo-a-passo abaixo serve para ilustrar isso melhor.
		</p>

		<ol>
			<li>
				A p√°gina nunca foi visitada.
			</li>

			<li>
				A p√°gina √© visitada pela primeira vez, e o m√©todo <span class="codigo">navigator.serviceWorker.register()</span> √© executado.
			</li>

			<li>
				O Service Worker √© baixado e instalado.
			</li>

			<li>
				Ocorre o evento <span class="codigo">install</span> do Service Worker.
				Nele, podemos passar uma Promise atrav√©s do m√©todo <span class="codigo">waitUntil()</span> do evento, para dizer ao navegador que o processo de instala√ß√£o ainda n√£o acabou (veja o <a href="sw.js" target="_blank">c√≥digo do Service Worker</a> para mais informa√ß√µes).
			</li>

			<li>
				Assim que o processo de instala√ß√£o termina, o que inclui a Promise passada para o m√©todo <span class="codigo">waitUntil()</span>, ocorre o evento <span class="codigo">activate</span>.
				Nele, podemos passar uma Promise atrav√©s do m√©todo <span class="codigo">waitUntil()</span> do evento, para dizer ao navegador que o processo de ativa√ß√£o ainda n√£o acabou (veja o <a href="sw.js" target="_blank">c√≥digo do Service Worker</a> para mais informa√ß√µes).
				Ainda dentro do evento, √© poss√≠vel executar o m√©todo <span class="codigo">clients.claim()</span>, fazendo com que o Service Worker assuma o controle at√© mesmo das p√°ginas que j√° est√£o abertas, e foram abertas <b>sem</b> o Service Worker.
			</li>
		</ol>

		<p>
			Quer ver isso acontecendo na pr√°tica?
		</p>
		
		<ol>
			<li>
				Remova o registro do Service Worker atual.
				<img alt="Remo√ß√£o do Service Worker" src="../assets/images/swunregister.png" />
			</li>

			<li>
				Edite o <a href="sw.js" target="_blank">arquivo do Service Worker</a>, removendo o coment√°rio da linha
				<br />
				<span class="codigo">//clients.claim();</span>
			</li>

			<li>
				Recarregue a p√°gina, e repare que a vers√£o do Service Worker vai ter mudado (no exemplo, a vers√£o antiga era #38).
				<img alt="Service Worker OK" src="../assets/images/swok.png" />
			</li>
			
			<li>
				As duas imagens iniciais de exemplo voltar√£o a aparecer como erro, porque no momento do novo carregamento da p√°gina n√£o existia um Service Worker instalado/ativo.
				Por√©m, clique no bot√£o "Adicionar Imagem" e veja que as novas imagens aparecem como as listras pretas e brancas, porque o Service Worker assumiu a p√°gina atual assim que sua ativa√ß√£o foi conclu√≠da!
				√â poss√≠vel saber quais p√°ginas est√£o sendo servidas pelo Service Worker olhando seus clientes:
				<img alt="Clientes do Service Worker" src="../assets/images/swclients.png" />
			</li>
		</ol>

		<div class="alerta">
			<p>
				Espero que uma coisa tenha ficado clara com os exemplos mostrados at√© aqui: os Service Workers s√£o entidades √† parte das p√°ginas, e n√£o meros scripts referenciados pelas p√°ginas!
				Eles t√™m seu pr√≥prio ciclo de vida!
				O m√©todo <span class="codigo">navigator.serviceWorker.register()</span> serve apenas para dizer para o navegador: <i>"Se voc√™ ainda n√£o instalou meu Service Worker, fa√ßa isso agora!"</i> (mas com educa√ß√£o üòÅ).
			</p>
			<p>
				Quer mais uma prova disso?
			</p>
			<p>
				V√° at√© l√° embaixo, dentro da tag <span class="codigo">&lt;script&gt;</span>, e <b>comente</b> o trecho <span class="codigo">navigator.serviceWorker.register("sw.js");</span>.
				Depois, atualize a p√°gina e veja que o navegador continua utilizando o Service Worker! Isso porque, uma vez registrado, o navegador s√≥ vai parar de utilizar o Service Worker para as p√°ginas de seu escopo, se voc√™ <a href="https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerRegistration/unregister" target="_blank">remover o registro do Service Worker</a>.
			</p>
		</div>

		<hr />

		<p>
			<small><a href="../">&laquo; Lista de exemplos</a></small>
		</p>

		<p>
			<small><a href="../pwa06/">&laquo; Exemplo 06</a></small>
		</p>

		<p>
			<small><a href="../pwa08/">Exemplo 08 &raquo;</a></small>
		</p>

		<p>
			<small>O c√≥digo-fonte e as explica√ß√µes podem ser encontradas no <a href="https://github.com/tech-espm/labs-pwa" target="_blank">GitHub do projeto: github.com/tech-espm/labs-pwa</a> üòä.</small>
		</p>

	</main>

	<script type="text/javascript">
		"use strict";

		// Devemos tomar cuidado para registrar o Service Worker apenas se o navegador atual entender o que √© isso!
		if ("serviceWorker" in navigator)
			navigator.serviceWorker.register("sw.js");

		var contador = 0, divPai = document.getElementById("divPai");

		function adicionarImagem() {
			var img = document.createElement("img");
			img.setAttribute("alt", "Imagem de exemplo");
			img.setAttribute("src", contador + ".jpg");

			divPai.appendChild(img);

			contador++;
		}
	</script>
</body>
</html>
